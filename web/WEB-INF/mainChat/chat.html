<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<title>WebChat</title>
	<link href="styles/chat.css" rel="stylesheet">
</head>
<body>
<script src="js/for_ajax.js"></script>
	<script>
		// <!-------------------------------------自定义内容------------------------------------->
		
		// 隐藏侧边菜单的最大宽度
		const fullWidth=600;
		
		// 中央主菜单宽度占比
		const mainWidthPer=60;
		
		// 调用控制台前、后缀
		const commandPrefix="$->";
		const commandSuffix="->$ENDLINE";
		
		// 默认时间格式
		const timeTypeDefault="HH:MM";
		
		// 默认输入框为收起状态
		isInputShow=false;
		
		// 输入框收起/展开高度
		const inputHeightHidden=30;
		const inputHeightShow=100;
		
		// 禁用标签
		const inputBannedLabel=["form", "input", "textarea", "menus", "fieldset"];
		
		// <!-------------------------------------预运算内容------------------------------------->
		
		// 侧边菜单宽度占比
		const sideWidthPer=(100-mainWidthPer)/2;
		
		chatHistory = new Array();
		
		inputHistory = [];
		inputHistoryPointer = 0;
		inputHistoryRead = 0;
		
		searchPass=false;
		searchKeyword="";
		
		const commandKeyword=[ 
			["cls", ["/?"] ], 
			
			["help", ["/?"] ], 
			
			["speak", 
			 ["[nickname]", 
			  ["[value]", 
			   ["[avatar]", 
				["[*from]"] ] ] ], 
			 ["/?"] ], 
			
			["timestamp", ["[*type]"], ["/?"] ] ];
		
		// <!-------------------------------------外部函数------------------------------------->
		
		// 计算文本在页面所占px宽度 -- 扩展String原型方法pxWidth
		String.prototype.pxWidth = function(font) {
			const canvas =
			  String.prototype.pxWidth.canvas ||
			  (String.prototype.pxWidth.canvas = document.createElement('canvas'))
			const context = canvas.getContext('2d')
			font && (context.font = font)
			const metrics = context.measureText(this)
			return metrics.width
		  }
		
		// <!-------------------------------------类声明------------------------------------->
		
		// 生成控件信息
		class childInfo{
			constructor(name, widthPer){
				this.widthPer=widthPer/100;
				this.fullWidthPer=1;
				this.width=htmlWidth*this.widthPer;
				this.fullWidth=htmlWidth;
				
				this.element=document.getElementsByClassName(name)[0];
			}
		}
		
		class childFunctions{
			new(){
				
				// 生成控件信息
				this.group=new childInfo("group", sideWidthPer);
				this.info=new childInfo("info", sideWidthPer);
				this.chat=new childInfo("chat", mainWidthPer);
				this.input=new childInfo("input", mainWidthPer);
				this.window=new childInfo("chatWindow", mainWidthPer);
			}
		}
		
		
		// <!-------------------------------------控制台相关函数声明------------------------------------->
		function commandSentInfo(){

		}
		// 清屏
		function commandCls(){

			let chatWindow=document.getElementsByClassName("chatWindow")[0];

			let chatDel=chatWindow.childNodes;
			for(i=chatDel.length-1;i>=0;i--)
				chatWindow.removeChild(chatDel[i]);

		}

		// 显示帮助信息
		function commandHelp(name="風又音理", avatar="default.jpg", from=false){

			showChatUnit(name, "Console commands list:<br>help 显示本帮助信息。<br>cls 清屏。<br>timestamp 打印一条时间戳。<br>speak 打印一段对话。<br>查询具体语法请用 /? ,如 !$:speak /?", avatar, from);

		}
		
		// 跳转到页尾
		function toEnd(){
			let t=document.querySelectorAll(".chatInner");
			if(t.length)
				t[t.length-1].scrollIntoView();
		}
		
		
		// <!-------------------------------------时间戳函数声明------------------------------------->
		
		// 生成时间戳单元
		function showTimeUnit(value="08:31"){
			
			// 判断是否为命令
			if (value.slice(0,commandPrefix.length)==commandPrefix){
				
				// 当命令为now时，将时间格式赋值为默认状态
				let args=( ( temp=value.slice( commandPrefix.length ) )=="now"? timeTypeDefault : temp);
				
				let argv=args.split(/:|-| /);
				
				// 正读取到args的位数
				let readLength=0;
				
				let timeOutput="";
				
				// 若入参MM类参数大于1，则默认首次出现的为月份，之后的为分钟
				let elementCount=0;
				argv.forEach( element=>{
					if("MMmm".indexOf(element)!=-1)
						elementCount++;
				})
				
				let isDate=(elementCount>1? true:false);
				
				// 逐条读取
				for(i=0;i<argv.length;i++){
					
					readLength+=argv[i].length;
					
					// 照入参args分隔符格式输出分隔符
					timeOutput+=timeCheck(argv[i], isDate)+( (temp=args[readLength++])==undefined? "" : temp );
					
					// 若当前入参为MM类，且isDate为true，则将isDate改为false，即之后的MM类入参被认为是分钟
					isDate=( ( isDate && ( "MMmm".indexOf(argv[i]) == -1 ) ) ? true : false );
				}
				
				if (timeOutput.indexOf("error")==-1)
					showTimeUnit(timeOutput);
				
				else
					console.log("Error at function showTimeUnit");
				
				return;
			}
				
			
			var timeInner=document.createElement('div');
			timeInner.classList.add('timeInner');
			
			let timeValue=document.createElement('div');
			timeValue.classList.add('timeValue');
			
			timeValue.style.width=value.pxWidth('normal 16px 华文细黑')+20+"px";
			
			timeValue.style.marginLeft=(child.chat.width-timeValue.style.width)/2 + "px";
			
			var timeValueText=document.createElement('div');
			timeValueText.classList.add('timeValueText');
			timeValueText.innerHTML=value;
			
			child.window.element.appendChild(timeInner);
			timeInner.appendChild(timeValue);
			timeValue.appendChild(timeValueText);
			
			chatHistory.push( (t=document.getElementsByClassName("timeInner"))[t.length-1]);
		}
		
		// 重绘时间戳位置
		function redrawTimeValue(){
			for(i=0;i<timeValue.length;i++)
				(t=timeValue[i].style).marginLeft=((isFull? child.chat.fullWidth : child.chat.width)-Number(t.width.slice(0,-2)))/2 + "px";
		}
		
		
		//<!-------------------------------------对话函数声明------------------------------------->
		
		// 生成对话单元
		function showChatUnit(nickname="Miku", value="みくみくみ", avatar="default.jpg", isMyself=false){
			
			var myself=(isMyself==true?"Self":"")
			
			var chatInner=document.createElement('div');
			chatInner.classList.add("chatInner");
			
			var chatUnit=document.createElement('div');
			chatUnit.classList.add('chatUnit');
			
			var chatAvatar=document.createElement('div');
			chatAvatar.classList.add('chatAvatar'+myself);
			
			var chatAvatarImg=document.createElement('img');
			chatAvatarImg.classList.add('chatAvatarImg'+myself);

			if(avatar==="default.jpg" || avatar==="noir.jpg"){
				chatAvatarImg.setAttribute("src", "source/images/avatars/"+avatar);
			}
			else{
				chatAvatarImg.setAttribute("src",avatar);
			}

			var chatName=document.createElement('div');
			chatName.classList.add('chatName'+myself);
			
			var chatNameText=document.createElement('div');
			chatNameText.classList.add('chatNameText');
			chatNameText.innerHTML=nickname;
			
			var chatValueSpace=document.createElement('div');
			chatValueSpace.classList.add('chatValueSpace'+myself);
			
			var chatValue=document.createElement('div');
			chatValue.classList.add('chatValue'+myself);
			
			var chatValueText=document.createElement('div');
			chatValueText.classList.add('chatValueText');
			chatValueText.innerHTML=value;
			
			child.window.element.appendChild(chatInner);
			
			chatInner.appendChild(chatUnit);
			chatUnit.appendChild(chatAvatar);
			chatUnit.appendChild(chatName);
			chatUnit.appendChild(chatValueSpace);
			
			chatAvatar.appendChild(chatAvatarImg);
			chatName.appendChild(chatNameText);
			chatValueSpace.appendChild(chatValue);
			chatValue.appendChild(chatValueText);
			
			chatHistory.push( (t=document.getElementsByClassName("chatInner"))[t.length-1]);
		}
		
		// 获取浏览器尺寸
		function readSizeHTML(){
			htmlWidth = document.documentElement.clientWidth;
			htmlHeight = document.documentElement.clientHeight;
			
			// 判断是否隐藏侧边菜单
			isFull=(htmlWidth<fullWidth? true:false);
		}
		
		// 重绘valueSpace尺寸
		function redrawValueSpace(name){
			per=(isFull? 1 : child.chat.widthPer);
				for (i=0;i<name.length;i++){
					if (name[i])
						name[i].style.width=htmlWidth*per-80 + "px";
				}
		}
		
		// 重绘group、info、chat、input尺寸
		function redrawMenu(){
			
			if (isFull){
				display="none";
				per=1;
				margin=0;
			}
			
			else {
				display="block";
				per=mainWidthPer/100;
				margin=(100-mainWidthPer)/2+"%";
			}
			
			child.group.element.style.display=display;
			child.group.element.style.width=child.group.widthPer*100+"%";
				
			child.info.element.style.display=display;
			child.info.element.style.width=child.info.widthPer*100+"%";

			child.chat.element.style.width=htmlWidth*per+"px";
			child.chat.element.style.marginLeft=margin;
			
			child.input.element.style.width=htmlWidth*per+"px";
			child.input.element.style.left=margin;
			
			
			margin=(isInputShow? inputHeightShow:inputHeightHidden);
			
			// 调整chatHistory最后两个元素的marginBottom
			if((t=chatHistory).length){
				if(t.length>1)
					t[t.length-2].style.marginBottom=0;
				t[t.length-1].style.marginBottom=margin+20+"px";
			}
			
			// 调整inputValueText及按钮
			child.input.element.style.height=margin+"px";
			
			document.getElementsByClassName("inputForm")[0].style.height=margin+"px";
			
			(t=document.getElementsByClassName("inputShowValue")[0]).style.height=margin+"px";
			t.value=(isInputShow? "Hide":"Show");
			
			document.getElementsByClassName("inputSubmit")[0].style.height=margin+"px";
			
			document.getElementsByClassName("inputValueText")[0].style.height=margin+"px";
		}
		
		// 引导重绘控件
		function redrawHTML(){
			
			//刷新浏览器尺寸
			readSizeHTML();
			
			child.new();
			
			// 重绘value尺寸
			redrawValueSpace(document.getElementsByClassName("chatValueSpace"));
			redrawValueSpace(document.getElementsByClassName("chatValueSpaceSelf"));
			
			// 重绘时间戳位置
			redrawTimeValue();
			
			// 重绘group、info、chat、input尺寸
			redrawMenu();
			
			toEnd();
		}
		
		// 提交表单后触发生成对话
		function chatPost(event, isKeyDown, str="", isSent=false){
			
			event=event||window.Event;
			
			value=document.getElementsByClassName("inputValueText")[0];
			
			// 提示文本框
			valueHelp=document.getElementsByClassName("inputValueTextHelp")[0];
			
			// 默认禁用自动填充
			let inputHelpFill=false;
			
			let inputHelpInfo="";
			
			let args=value.value.slice(commandPrefix.length);

			let argv=args.split(" ");
			
			// 已读取argv的个数
			let argvRead=0;
			
			let argvPointer=0;
			
			// 按键落下/抬起 仅计算一遍

			
			// 触发提示文本
			if (value.value.slice(0,commandPrefix.length)==commandPrefix){

				valueHelp.value="$->";
				
				
				
				let result=[];
				
				result=keywordSearch(argv, commandKeyword);
				inputHelpInfo+=result;
				inputHelpFill=( (t=inputHelpInfo.split(" "))[argv.length-1][0]=="["? false:true );
				
				valueHelp.value+=inputHelpInfo;
				
			}
			
			else {
				valueHelp.value="";
			}
			
			// 自动填充函数
			if (isKeyDown==true){
				// 当按下 ↑ 或 ↓ 则读取上/下一条历史输入
				if (event.keyCode==38){
					event.preventDefault();

					value.value=( (t=inputHistory[ inputHistory.length-(inputHistoryRead=(++inputHistoryRead<=inputHistory.length? inputHistoryRead:inputHistory.length) ) ])==undefined? "":t );

					return;
				}

				if (event.keyCode==40){
					event.preventDefault();

					value.value=( (inputHistoryRead=(--inputHistoryRead<0? 0:inputHistoryRead)) >= 1 ? inputHistory[ inputHistory.length - inputHistoryRead]:"");

					return;
				}

				// tab自动填充提示文本内容
				if (event.keyCode==9){
					event.preventDefault();

					if (inputHelpFill){
						let inputHelpInfoOutput = valueHelp.value.split(" ").slice(0,argv.length);
						value.value="";
						
						for(i=0;i<inputHelpInfoOutput.length;i++){
							value.value+=inputHelpInfoOutput[i];
							
							if (i<inputHelpInfoOutput.length-1)
								value.value+=" ";
						}
					}
				}
			}
			
			// 当按下回车，或输入为空时返回。
			if (value.value == "undefined")
				return;

			if (str!==""){
				showChatUnit("ノワール", str, "noir.jpg", true);
				redrawHTML();
				
				return;
			}


			// 输入回车或按下Sent
			if (event.keyCode==13 || isSent){
				
				
				let value=document.getElementsByClassName("inputValueText")[0];
				let valueText=value.value;
				
				event.preventDefault();
				
				if ( !valueText || valueText == "\n" ){
					value.value="";
					return;
				}
				
				inputHistory.push(valueText);
				inputHistoryRead=0;
				
				for (i=0;i<inputBannedLabel.length;i++){
					if (valueText.indexOf("<"+inputBannedLabel[i])!=-1 || valueText.indexOf(inputBannedLabel[i]+">")!=-1 || valueText.indexOf("</"+inputBannedLabel[i]+">")!=-1 ){
						showChatUnit("風又音理", "<div class='chatValueTextWarning'>你没有使用此命令的权限。</div>", "default.jpg");
						value.value="";
						
						redrawHTML();
						return;
					}
				}
				
				
				if ( (valueCommand = valueText ).slice(0,commandPrefix.length) != commandPrefix){
					showChatUnit("ノワール", value.value, "noir.jpg", true);
					sendChatToServer(me,value.value);
					value.value="";
					redrawHTML();
				}

				else{

					
					let argv=valueCommand.slice(3).split(" ");
					let command=argv[0];
					let isHelp=(argv[1]=="/?"? true:false);

					let err=false;

					// 清屏
					if(  command=="cls" ) {

						//!$:cls

						if(isHelp)
							showChatUnit("風又音理", commandPrefix+"cls", "default.jpg");

						else{
							commandCls();
						}
					}

					// 生成时间戳
					else if ( command=="timestamp" ) {

						//!$:timestamp [type="now"]

						if (isHelp)
							showChatUnit("風又音理", commandPrefix+"timestamp", "default.jpg");

						let args=(argv[1]? argv[1] : "now")+(argv[2]? " "+argv[2] : "");
						
						showTimeUnit(commandPrefix+args);
					}

					// 生成对话单元
					else if ( command=="speak" ) {

						//!$:speak ノワール ...suki noir.jpg

						if(isHelp){
							showChatUnit("風又音理", commandPrefix+"speak [username] [value] [avatar] [*from]", "default.jpg");

							showChatUnit("風又音理", "[nickname]用户昵称，如 “風又音理”。<br>[value]发言内容，如 “......探して。”。<br>[avatar]用户头像(带后缀名)，如 “default.jpg”。<br>[*from]是否来自己方发送，“true”或“false(默认为false)。", "default.jpg");
						}

						else {

							if (argv.length==4){
								showChatUnit(argv[1], argv[2], argv[3]);
							}
							else if (argv.length==5){
								showChatUnit(argv[1], argv[2], argv[3], (argv[4]=="true"? true:false) );
							}
							else
								err=true;
						}
					}

					// 显示帮助信息
					else if ( command=="help" ) {

						//!$:help

						if(isHelp)
							showChatUnit("風又音理", commandPrefix+"help", "default.jpg");

						else
							commandHelp();

					}

					// 无此命令
					else{
						err=true;
					}

					if (err)
						showChatUnit("風又音理", "命令语法不正确，请检查拼写。", "default.jpg");
					
					valueCommand+=commandSuffix;

					value.value="";
					redrawHTML();

					return;
				}
			}
		}
		
		// 展开/收起输入框
		function inputShowValue(){
			isInputShow=(isInputShow? false:true);
			
			redrawMenu();
			toEnd();
		}
		
		// 若输出字符串长度为1则向前填充0至两位
		function toTwoBits(str){
			return (str.length==1? "0"+str : str);
		}
		
		// 处理时间格式参数
		function timeCheck(argv, isDate=false){
			
			
			let t=new Date();

			let year=t.getFullYear();
			let month=t.getMonth()+1;
			let date=t.getDate();
			let day=t.getDay();
			let hour=t.getHours();
			let minute=t.getMinutes();

			let result="";
			
			switch(argv){
					
				case "YYYY":
					result=year.toString();
					break;
					
				case "yyyy":
					result=year.toString();
					break;
					
				case "YY":
					result=year.toString().slice(2,4);
					break;
					
				case "yy":
					result=year.toString().slice(2,4);
					break;
					
				case "DD":
					result=toTwoBits(date.toString());
					break;

				case "dd":
					result=toTwoBits(date.toString());
					break;

				case "D":
					result=date.toString();
					break;

				case "d":
					result=date.toString();
					break;

				// 24小时格式
				case "HH":
					result=toTwoBits(hour.toString());
					break;

				// 12小时格式
				case "hh":
					result=toTwoBits( (hour>12? hour-=12 : hour).toString() );
					break;

				case "H":
					result=hours.toString();
					break;

				case "h":
					result=(hour>12? hour-=12 : hour).toString()
					break;

				case "MM":
					result=toTwoBits( ( isDate? month : minute ).toString() ) ;
					break;

				case "mm":
					result=toTwoBits( ( isDate? month : minute ).toString() ) ;
					break;

				case "M":
					result=( isDate? month : minute ).toString();
					break;

				case "m":
					result=( isDate? month : (minute>12? minute-=12 : minute) ).toString()
					break;

				default:
					result="error";
			}
			
			return result;
		}
		
		// 搜索关键字 args=输入的部分关键字 argv=前往搜索的数组
		function keywordSearch(args, argv){
			
			if (argv==undefined )
				return undefined;
			
			let result="";
			
			let t=[];
			

			let i=0;
			for(i=0;i<argv.length;i++){
				let keyword=argv[i][0];

				if ( (keyword.length>1) && (keyword.indexOf(args[0])==0 || (keyword.indexOf("[")==0 && args[0]==undefined) ) ){
					result=keyword+" ";
					
					
					if(argv[i][1]!=undefined){
						t=keywordSearch(args.slice(1), argv[i]);

						if (t!=undefined && t!=[]){
							result+=t+" ";
						}
					}
					
					if (keyword.indexOf(args[0])==0)
						// 删去结尾多余空格
						result=result.slice(0,-1);
				}

			}
			
			return result;
		}
		
		
	</script>
	
	<style type="text/css">
		textarea, input{
			border: none;
			box-shadow:none;
			outline: none;
		}
	</style>
	
	
	<div class="input">
		<div class="inputWindow">
			<form class="inputForm">
				<textarea rows="1" cols="60" onKeyDown="chatPost(event, true)" onKeyUp="chatPost(event, false)" class="inputValueText"></textarea>
				<input type="button" class="inputShowValue" value="Show" onClick="inputShowValue()">
				<input type="button" class="inputSubmit" value="Sent" onClick=chatPost(event,0,"",true)>
				<textarea rows="1" cols="60" class="inputValueTextHelp" readonly></textarea>
			</form>
		</div>
	</div>
	
	<div class="navi">
		<div class="naviWindow">
		</div>
	</div>
	
	<div class="group">
		<div class="groupWindow">
		</div>
	</div>
	
	<div class="chat">
		<div class="chatWindow" id="window">
			
			<script>
				// 读取浏览器尺寸
				readSizeHTML();

				child=new childFunctions();
				child.new();
				
				showTimeUnit("08:31");
				
				showChatUnit("風又音理", "...探して。", "default.jpg");
				showChatUnit("風又音理", "心臓の中で、探して！", "default.jpg");
				showChatUnit("風又音理", "探して！", "default.jpg");
				
				showTimeUnit(commandPrefix+"now");
				
				showChatUnit("ノワール", "......楽しい旅をします。", "noir.jpg", true);
				showChatUnit("ノワール", "あなたと一緒に、旅を。", "noir.jpg", true);
			</script>
		</div>
	</div>
	
	<div class="info">
		<div class="infoWindow">
		</div>
	</div>
	
	<script>
		
		// 更新控件信息
		timeValue=document.getElementsByClassName("timeValue");
		
		// 重绘控件尺寸
		redrawHTML();
		
		// 监听浏览器尺寸变化
		window.addEventListener("resize", redrawHTML);
	</script>
</body>
</html>
